function R(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var V=x;function x(t,e,n,r){var o,u,i,v,a,s,l,c,f,g,m,M,w,y;for(typeof e!="function"&&(r=n,n=e,e=null),r=r||{},v=r.tolerance===void 0?1e-7:r.tolerance,y=r.epsilon===void 0?2220446049250313e-31:r.epsilon,a=r.maxIterations===void 0?20:r.maxIterations,m=r.h===void 0?1e-4:r.h,w=r.verbose===void 0?!1:r.verbose,M=1/m,s=0;s++<a;){if(u=t(n),e?i=e(n):(l=t(n+m),c=t(n-m),f=t(n+2*m),g=t(n-2*m),i=(g-f+8*(l-c))*M/12),Math.abs(i)<=y*Math.abs(u))return w&&console.log("Newton-Raphson: failed to converged due to nearly zero first derivative"),!1;if(o=n-u/i,Math.abs(o-n)<=v*Math.abs(o))return w&&console.log("Newton-Raphson: converged to x = "+o+" after "+s+" iterations"),o;n=o}return w&&console.log("Newton-Raphson: Maximum iterations reached ("+a+")"),!1}var P=V,N=1e3*60*60*24,E=365;function _(t){if(!t||!t.length||!t.forEach||t.length<2)throw new Error("Argument is not an array with length of 2 or more.");var e=[],n=Math.floor(t[0].when/N),r=n,o=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,i=0,v=0;if(t.forEach(function(a){i+=a.amount,a.amount<0&&(v+=-a.amount);var s=Math.floor(a.when/N);n=Math.min(n,s),r=Math.max(r,s),o=Math.min(o,a.amount),u=Math.max(u,a.amount),e.push({amount:a.amount,epochDays:s})}),n===r)throw new Error("Transactions must not all be on the same day.");if(o>=0)throw new Error("Transactions must not all be nonnegative.");if(u<0)throw new Error("Transactions must not all be negative.");return e.forEach(function(a){a.years=(r-a.epochDays)/E}),{total:i,deposits:v,days:r-n,investments:e,maxAmount:u}}function Y(t,e){var n=_(t);if(n.maxAmount===0)return-1;var r=n.investments,o=function(a){return r.reduce(function(s,l){var c=l.amount,f=l.years;return-1<a?s+c*Math.pow(1+a,f):a<-1?s-Math.abs(c)*Math.pow(-1-a,f):f===0?s+c:s},0)},u=function(a){return r.reduce(function(s,l){var c=l.amount,f=l.years;return f===0?s:-1<a?s+c*f*Math.pow(1+a,f-1):a<-1?s+Math.abs(c)*f*Math.pow(-1-a,f-1):s},0)},i=e?e.guess:void 0;if(i&&isNaN(i))throw new Error("option.guess must be a number.");i||(i=n.total/n.deposits/(n.days/E));var v=P(o,u,i,e);if(v===!1)throw new Error("Newton-Raphson algorithm failed to converge.");return v}var O=Y,C=R(O);const U=1e3*60*60*24;function X(t){if(t.length<2)return!0;const e=[...t].sort((n,r)=>n.date.getTime()-r.date.getTime());for(let n=1;n<e.length;n++){const r=e[n-1].date;if((e[n].date.getTime()-r.getTime())/U!==1)return!1}return!0}function K(t,e){const n=new Date(t),r=n.getDate();return n.setMonth(n.getMonth()-e),n.getDate()<r&&n.setDate(0),n}function j(t){if(t.length===0)return[];const e=[...t].sort((i,v)=>i.date.getTime()-v.date.getTime()),n=[];let r=0,o=new Date(e[0].date);const u=e[e.length-1].date;for(;o<=u;)r<e.length&&L(o,e[r].date)?(n.push({date:new Date(o),nav:e[r].nav}),r++):n.push({date:new Date(o),nav:e[r].nav}),o.setDate(o.getDate()+1);return n}function L(t,e){return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()}function J(t,e=1,n,r=!1,o=5){if(!G(t))return[];const u=e*12,i=t.map(q),v=i.map(B),a=H(i[0]),s=a[0];return a.flatMap(l=>$(l,v,u,s,n,r,o))}function $(t,e,n,r,o,u,i){const{transactions:v,unitsPerFund:a}=k(t,e,n,r,o,u,i);if(!v)return[];const s=z(t,e,a);if(!s)return[];const l=[...v,...s],c=new Map;for(const g of l){const m=T(g.when),M=c.get(m)||0;c.set(m,M+g.amount)}const f=Array.from(c.entries()).map(([g,m])=>({amount:m,when:new Date(g)}));f.sort((g,m)=>g.when.getTime()-m.when.getTime());try{const g=C(f);return[{date:t,xirr:g,transactions:l}]}catch(g){return console.warn(`XIRR calculation failed for date ${t.toISOString()}:`,g),[]}}function k(t,e,n,r,o,u,i){const a=e.length,s=[],l=new Array(a).fill(0),c=new Array(a).fill(0);for(let f=n;f>=1;f--){const g=K(t,f);if(g<r)return{transactions:null,unitsPerFund:l};const m=T(g),M=[];let w=0;const y=new Array(a).fill(0);for(let d=0;d<a;d++){const h=e[d].get(m);if(!h)return{transactions:null,unitsPerFund:l};const b=100*(o[d]/100),D=b/h.nav;c[d]+=D,l[d]+=D;const I=c[d]*h.nav;y[d]=I,w+=I;const A={fundIdx:d,nav:h.nav,when:h.date,units:D,amount:-b,type:"buy",cumulativeUnits:c[d],currentValue:I};M.push(A)}for(const d of M){if(w>0){const p=y[d.fundIdx];d.allocationPercentage=p/w*100}else d.allocationPercentage=0;s.push(d)}if(u){let d=!1;for(let p=0;p<a;p++){const h=y[p]/w*100,F=o[p];if(Math.abs(h-F)>i){d=!0;break}}if(d&&w>0){const p=[];for(let h=0;h<a;h++){const b=e[h].get(m);if(!b)return{transactions:null,unitsPerFund:l};const I=w*(o[h]/100)-y[h];if(Math.abs(I)>.01){const A=I/b.nav;c[h]+=A,l[h]+=A;const S={fundIdx:h,when:g,nav:b.nav,units:A,amount:-I,type:"rebalance",cumulativeUnits:c[h],currentValue:c[h]*b.nav,allocationPercentage:o[h]};p.push(S)}}s.push(...p)}}}return{transactions:s,unitsPerFund:l}}function z(t,e,n){const r=e.length,o=T(t),u=[];for(let i=0;i<r;i++){const a=e[i].get(o);if(!a)return null;const s=n[i],l=s*a.nav;u.push({fundIdx:i,nav:a.nav,when:a.date,units:s,amount:l,type:"sell",cumulativeUnits:s,currentValue:s*a.nav})}return u}function G(t){return t.length>0&&!t.some(e=>e.length<2)}function q(t){return X(t)?t:j(t)}function B(t){return new Map(t.map(e=>[T(e.date),e]))}function H(t){return[...t].sort((e,n)=>e.date.getTime()-n.date.getTime()).map(e=>e.date)}function T(t){return t.toISOString().split("T")[0]}export{J as calculateSipRollingXirr};
