function X(t){if(t.length<2)return!0;const e=[...t].sort((n,r)=>n.date.getTime()-r.date.getTime());for(let n=1;n<e.length;n++){const r=e[n-1].date;if((e[n].date.getTime()-r.getTime())/864e5!==1)return!1}return!0}function $(t,e){const n=new Date(t),r=n.getDate();return n.setMonth(n.getMonth()-e),n.getDate()<r&&n.setDate(0),n}function z(t){if(t.length===0)return[];const e=[...t].sort((s,l)=>s.date.getTime()-l.date.getTime()),n=[];let r=0,a=new Date(e[0].date);const o=e[e.length-1].date;for(;a<=o;)r<e.length&&K(a,e[r].date)?(n.push({date:new Date(a),nav:e[r].nav}),r++):n.push({date:new Date(a),nav:e[r].nav}),a.setDate(a.getDate()+1);return n}function K(t,e){return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()}function b(t){return t.length>0&&!t.some(e=>e.length<2)}function F(t){return X(t)?t:z(t)}function N(t){return new Map(t.map(e=>[y(e.date),e]))}function R(t){return[...t].sort((e,n)=>e.date.getTime()-n.date.getTime()).map(e=>e.date)}function y(t){return t.toISOString().split("T")[0]}function E(t,e,n){const r=new Set;let a=null;for(let o=e;o>=1;o--){const s=$(t,o);if(s<n)return{dateSet:r,earliestDate:null};r.add(y(s)),(!a||s<a)&&(a=s)}return{dateSet:r,earliestDate:a}}function L(t,e){const n=t.getFullYear()-e.getFullYear(),r=t.getMonth()-e.getMonth();return n+(r>=0?0:-1)+1}function W(t,e,n,r,a,o,s,l,i){let c=i;if(s&&l>0){const m=L(a,o);c=i*Math.pow(1+l/100,m-1)}const f=[];let h=0;const u=[];for(let m=0;m<e.length;m++){const g=e[m].get(t);if(!g)return null;const v=c*(n[m]/100),d=v/g.nav;r.cumulativeUnits[m]+=d,r.unitsPerFund[m]+=d;const w=r.cumulativeUnits[m]*g.nav;u.push(w),h+=w,f.push({fundIdx:m,nav:g.nav,when:g.date,units:d,amount:-v,type:"buy",cumulativeUnits:r.cumulativeUnits[m],currentValue:w,allocationPercentage:0})}return f.forEach((m,g)=>{m.allocationPercentage=h>0?u[g]/h*100:0}),{transactions:f,portfolioValue:h}}function j(t,e,n,r,a,o,s){if(!q(s.cumulativeUnits,n,t,r,a,o))return[];const l=[];for(let i=0;i<n.length;i++){const c=n[i].get(t);if(!c)return null;const f=s.cumulativeUnits[i]*c.nav,u=o*(r[i]/100)-f;if(Math.abs(u)>.01){const m=u/c.nav;s.cumulativeUnits[i]+=m,s.unitsPerFund[i]+=m,l.push({fundIdx:i,when:new Date(e),nav:c.nav,units:m,amount:-u,type:"rebalance",cumulativeUnits:s.cumulativeUnits[i],currentValue:s.cumulativeUnits[i]*c.nav,allocationPercentage:r[i]})}}return l}function q(t,e,n,r,a,o){for(let s=0;s<e.length;s++){const l=e[s].get(n);if(!l)continue;const c=t[s]*l.nav/o*100,f=r[s];if(Math.abs(c-f)>a)return!0}return!1}function B(t,e,n){const r=[];let a=0;for(let o=0;o<e.length;o++){const s=e[o].get(t);if(!s)return null;const l=n.cumulativeUnits[o]*s.nav;a+=l,r.push({fundIdx:o,when:s.date,nav:s.nav,units:0,amount:0,type:"nil",cumulativeUnits:n.cumulativeUnits[o],currentValue:l,allocationPercentage:0})}return r.forEach(o=>{o.allocationPercentage=a>0?o.currentValue/a*100:0}),r}function x(t,e,n){const r=y(t),a=[];for(let o=0;o<e.length;o++){const s=e[o].get(r);if(!s)return null;const l=n[o],i=l*s.nav;a.push({fundIdx:o,nav:s.nav,when:s.date,units:l,amount:i,type:"sell",cumulativeUnits:l,currentValue:l*s.nav})}return a}function G(t,e,n,r,a,o,s,l,i,c){const f=E(t,n,r);if(!f.earliestDate)return null;const h=P(e.length),u=k(f.earliestDate,t,f.dateSet,e,a,o,s,l,i,c,h);if(!u)return null;const m=x(t,e,h.unitsPerFund);return m?{transactions:[...u.transactions,...m],dailyValues:u.dailyValues}:null}function A(t,e,n,r,a,o,s,l,i,c){const f=E(t,n,r);if(!f.earliestDate)return null;const h=P(e.length),u=H(f.earliestDate,t,f.dateSet,e,a,o,s,l,i,c,h);if(!u)return null;const m=x(t,e,h.unitsPerFund);return m?[...u,...m]:null}function P(t){return{unitsPerFund:new Array(t).fill(0),cumulativeUnits:new Array(t).fill(0)}}function k(t,e,n,r,a,o,s,l,i,c,f){const h=[],u=[],m=new Date(t),g=new Date(t);for(;m<=e;){const v=y(m),d=m<e&&n.has(v);let w=0;if(d){const S=Y(v,m,r,a,o,s,g,l,i,c,f);if(!S)return null;h.push(...S),w=S.filter(V=>V.type==="buy").reduce((V,O)=>V+O.amount,0)}const I=J(v,m,r,f,w);if(!I)return null;u.push(I),m.setDate(m.getDate()+1)}return{transactions:h,dailyValues:u}}function H(t,e,n,r,a,o,s,l,i,c,f){const h=[],u=new Date(t),m=new Date(t);for(;u<e;){const g=y(u),d=n.has(g)?Y(g,u,r,a,o,s,m,l,i,c,f):Q(g,r,f);if(!d)return null;h.push(...d),u.setDate(u.getDate()+1)}return h}function J(t,e,n,r,a){let o=0;for(let s=0;s<n.length;s++){const l=n[s].get(t);if(!l)return null;const i=r.cumulativeUnits[s]*l.nav;o+=i}return{date:new Date(e),totalValue:o,cashFlow:a}}function Y(t,e,n,r,a,o,s,l,i,c,f){const h=W(t,n,r,f,e,s,l,i,c);if(!h)return null;const u=a?j(t,e,n,r,o,h.portfolioValue,f):[];return u===null?null:[...h.transactions,...u]}function Q(t,e,n){return B(t,e,n)}function Z(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var tt=et;function et(t,e,n,r){var a,o,s,l,i,c,f,h,u,m,g,v,d,w;for(typeof e!="function"&&(r=n,n=e,e=null),r=r||{},l=r.tolerance===void 0?1e-7:r.tolerance,w=r.epsilon===void 0?2220446049250313e-31:r.epsilon,i=r.maxIterations===void 0?20:r.maxIterations,g=r.h===void 0?1e-4:r.h,d=r.verbose===void 0?!1:r.verbose,v=1/g,c=0;c++<i;){if(o=t(n),e?s=e(n):(f=t(n+g),h=t(n-g),u=t(n+2*g),m=t(n-2*g),s=(m-u+8*(f-h))*v/12),Math.abs(s)<=w*Math.abs(o))return d&&console.log("Newton-Raphson: failed to converged due to nearly zero first derivative"),!1;if(a=n-o/s,Math.abs(a-n)<=l*Math.abs(a))return d&&console.log("Newton-Raphson: converged to x = "+a+" after "+c+" iterations"),a;n=a}return d&&console.log("Newton-Raphson: Maximum iterations reached ("+i+")"),!1}var nt=tt,M=1e3*60*60*24,_=365;function rt(t){if(!t||!t.length||!t.forEach||t.length<2)throw new Error("Argument is not an array with length of 2 or more.");var e=[],n=Math.floor(t[0].when/M),r=n,a=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,s=0,l=0;if(t.forEach(function(i){s+=i.amount,i.amount<0&&(l+=-i.amount);var c=Math.floor(i.when/M);n=Math.min(n,c),r=Math.max(r,c),a=Math.min(a,i.amount),o=Math.max(o,i.amount),e.push({amount:i.amount,epochDays:c})}),n===r)throw new Error("Transactions must not all be on the same day.");if(a>=0)throw new Error("Transactions must not all be nonnegative.");if(o<0)throw new Error("Transactions must not all be negative.");return e.forEach(function(i){i.years=(r-i.epochDays)/_}),{total:s,deposits:l,days:r-n,investments:e,maxAmount:o}}function at(t,e){var n=rt(t);if(n.maxAmount===0)return-1;var r=n.investments,a=function(i){return r.reduce(function(c,f){var h=f.amount,u=f.years;return-1<i?c+h*Math.pow(1+i,u):i<-1?c-Math.abs(h)*Math.pow(-1-i,u):u===0?c+h:c},0)},o=function(i){return r.reduce(function(c,f){var h=f.amount,u=f.years;return u===0?c:-1<i?c+h*u*Math.pow(1+i,u-1):i<-1?c+Math.abs(h)*u*Math.pow(-1-i,u-1):c},0)},s=e?e.guess:void 0;if(s&&isNaN(s))throw new Error("option.guess must be a number.");s||(s=n.total/n.deposits/(n.days/_));var l=nt(a,o,s,e);if(l===!1)throw new Error("Newton-Raphson algorithm failed to converge.");return l}var ot=at,st=Z(ot);function U(t,e){const n=it(t);return lt(n,e)}function it(t){const e=new Map;for(const r of t){if(r.type==="nil")continue;const a=y(r.when),o=e.get(a)||0;e.set(a,o+r.amount)}const n=Array.from(e.entries()).map(([r,a])=>({amount:a,when:new Date(r)}));return n.sort((r,a)=>r.when.getTime()-a.when.getTime()),n}function lt(t,e){try{return st(t)}catch(n){return console.warn(`XIRR calculation failed for date ${e.toISOString()}:`,n),null}}const ut=252;function C(t){if(t.length<2)return 0;const e=ct(t);if(e.length<2)return 0;const n=e.reduce((f,h)=>f+h,0)/e.length,r=e.reduce((f,h)=>{const u=h-n;return f+u*u},0)/e.length,a=Math.sqrt(r),o=t.length-1,s=e.length,l=o>0?Math.round(s/o*365):ut;return a*Math.sqrt(l)*100||0}function ct(t){const e=[];for(let n=1;n<t.length;n++){const r=t[n-1],a=t[n];if(r.totalValue>0){const o=a.totalValue-r.totalValue;if(o===0&&a.cashFlow===0)continue;const s=(o+a.cashFlow)/r.totalValue;e.push(s)}}return e}let p=0,D=0,T=0;function gt(t,e=1,n,r=!1,a=5,o=!1,s=!1,l=0,i=100){if(p=0,D=0,T=0,!b(t))return[];const c=e*12,f=t.map(F),h=f.map(N),u=R(f[0]),m=u[0],g=u.flatMap(v=>ft(v,h,c,m,n,r,a,o,s,l,i));return console.log(`[SIP Calc] Transactions: ${(T/1e3).toFixed(2)}s | XIRR: ${(p/1e3).toFixed(2)}s | Volatility: ${(D/1e3).toFixed(2)}s | Total entries: ${g.length}`),g}function ft(t,e,n,r,a,o,s,l,i,c,f){if(l)return ht(t,e,n,r,a,o,s,i,c,f);const h=performance.now(),u=G(t,e,n,r,a,o,s,i,c,f);if(T+=performance.now()-h,!u)return[];const m=performance.now(),g=U(u.transactions,t);if(p+=performance.now()-m,g===null)return[];const v=performance.now(),d=C(u.dailyValues);return D+=performance.now()-v,[{date:t,xirr:Math.round(g*1e4)/1e4,transactions:u.transactions,volatility:Math.round(d*1e4)/1e4}]}function ht(t,e,n,r,a,o,s,l,i,c){const f=performance.now(),h=A(t,e,n,r,a,o,s,l,i,c);if(T+=performance.now()-f,!h)return[];const u=performance.now(),m=U(h,t);if(p+=performance.now()-u,m===null)return[];const g=performance.now(),v=mt(h),d=C(v);return D+=performance.now()-g,[{date:t,xirr:Math.round(m*1e4)/1e4,transactions:h,volatility:Math.round(d*1e4)/1e4}]}function mt(t){const e=t.filter(a=>a.type==="nil"||a.type==="buy"),n=new Map;for(const a of e){const o=a.when.toISOString().split("T")[0];n.has(o)||n.set(o,[]),n.get(o).push(a)}const r=[];for(const[,a]of n.entries()){const o=a.reduce((l,i)=>l+i.currentValue,0),s=a.filter(l=>l.type==="buy").reduce((l,i)=>l+i.amount,0);o>0&&r.push({date:a[0].when,totalValue:o,cashFlow:s})}return r.sort((a,o)=>a.date.getTime()-o.date.getTime()),r}function dt(t,e,n,r,a,o,s,l,i){if(!b(t))return null;const c=n*12,f=t.map(F),h=f.map(N),m=R(f[0])[0];return A(e,h,c,m,r,a,o,s,l,i)}export{gt as calculateSipRollingXirr,dt as recalculateTransactionsForDate};
//# sourceMappingURL=index-ac57251a.js.map
