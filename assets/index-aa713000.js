function M(t){if(t.length<2)return!0;const e=[...t].sort((n,r)=>n.date.getTime()-r.date.getTime());for(let n=1;n<e.length;n++){const r=e[n-1].date;if((e[n].date.getTime()-r.getTime())/864e5!==1)return!1}return!0}function T(t,e){const n=new Date(t),r=n.getDate();return n.setMonth(n.getMonth()-e),n.getDate()<r&&n.setDate(0),n}function I(t){if(t.length===0)return[];const e=[...t].sort((i,u)=>i.date.getTime()-u.date.getTime()),n=[];let r=0,a=new Date(e[0].date);const o=e[e.length-1].date;for(;a<=o;)r<e.length&&S(a,e[r].date)?(n.push({date:new Date(a),nav:e[r].nav}),r++):n.push({date:new Date(a),nav:e[r].nav}),a.setDate(a.getDate()+1);return n}function S(t,e){return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()}function V(t){return t.length>0&&!t.some(e=>e.length<2)}function b(t){return M(t)?t:I(t)}function E(t){return new Map(t.map(e=>[w(e.date),e]))}function R(t){return[...t].sort((e,n)=>e.date.getTime()-n.date.getTime()).map(e=>e.date)}function w(t){return t.toISOString().split("T")[0]}function A(t,e,n){const r=new Set;let a=null;for(let o=e;o>=1;o--){const i=T(t,o);if(i<n)return{dateSet:r,earliestDate:null};r.add(w(i)),(!a||i<a)&&(a=i)}return{dateSet:r,earliestDate:a}}function N(t,e){const n=t.getFullYear()-e.getFullYear(),r=t.getMonth()-e.getMonth();return n+(r>=0?0:-1)+1}function F(t,e,n,r,a,o,i,u,l){let c=l;if(i&&u>0){const g=N(a,o);c=l*Math.pow(1+u/100,g-1)}const h=[];let f=0;const s=[];for(let g=0;g<e.length;g++){const v=e[g].get(t);if(!v)return null;const m=c*(n[g]/100),d=m/v.nav;r.cumulativeUnits[g]+=d,r.unitsPerFund[g]+=d;const y=r.cumulativeUnits[g]*v.nav;s.push(y),f+=y,h.push({fundIdx:g,nav:v.nav,when:v.date,units:d,amount:-m,type:"buy",cumulativeUnits:r.cumulativeUnits[g],currentValue:y,allocationPercentage:0})}return h.forEach((g,v)=>{g.allocationPercentage=f>0?s[v]/f*100:0}),{transactions:h,portfolioValue:f}}function P(t,e,n,r,a,o,i){if(!Y(i.cumulativeUnits,n,t,r,a,o))return[];const u=[];for(let l=0;l<n.length;l++){const c=n[l].get(t);if(!c)return null;const h=i.cumulativeUnits[l]*c.nav,s=o*(r[l]/100)-h;if(Math.abs(s)>.01){const g=s/c.nav;i.cumulativeUnits[l]+=g,i.unitsPerFund[l]+=g,u.push({fundIdx:l,when:new Date(e),nav:c.nav,units:g,amount:-s,type:"rebalance",cumulativeUnits:i.cumulativeUnits[l],currentValue:i.cumulativeUnits[l]*c.nav,allocationPercentage:r[l]})}}return u}function Y(t,e,n,r,a,o){for(let i=0;i<e.length;i++){const u=e[i].get(n);if(!u)continue;const c=t[i]*u.nav/o*100,h=r[i];if(Math.abs(c-h)>a)return!0}return!1}function _(t,e,n){const r=[];let a=0;for(let o=0;o<e.length;o++){const i=e[o].get(t);if(!i)return null;const u=n.cumulativeUnits[o]*i.nav;a+=u,r.push({fundIdx:o,when:i.date,nav:i.nav,units:0,amount:0,type:"nil",cumulativeUnits:n.cumulativeUnits[o],currentValue:u,allocationPercentage:0})}return r.forEach(o=>{o.allocationPercentage=a>0?o.currentValue/a*100:0}),r}function U(t,e,n){const r=w(t),a=[];for(let o=0;o<e.length;o++){const i=e[o].get(r);if(!i)return null;const u=n[o],l=u*i.nav;a.push({fundIdx:o,nav:i.nav,when:i.date,units:u,amount:l,type:"sell",cumulativeUnits:u,currentValue:u*i.nav})}return a}function x(t,e,n,r,a,o,i,u,l,c){const h=A(t,n,r);if(!h.earliestDate)return null;const f=C(e.length),s=O(h.earliestDate,t,h.dateSet,e,a,o,i,u,l,c,f);if(!s)return null;const g=U(t,e,f.unitsPerFund);return g?[...s,...g]:null}function C(t){return{unitsPerFund:new Array(t).fill(0),cumulativeUnits:new Array(t).fill(0)}}function O(t,e,n,r,a,o,i,u,l,c,h){const f=[],s=new Date(t),g=new Date(t);for(;s<e;){const v=w(s),d=n.has(v)?$(v,s,r,a,o,i,g,u,l,c,h):K(v,r,h);if(!d)return null;f.push(...d),s.setDate(s.getDate()+1)}return f}function $(t,e,n,r,a,o,i,u,l,c,h){const f=F(t,n,r,h,e,i,u,l,c);if(!f)return null;const s=a?P(t,e,n,r,o,f.portfolioValue,h):[];return s===null?null:[...f.transactions,...s]}function K(t,e,n){return _(t,e,n)}function X(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var z=L;function L(t,e,n,r){var a,o,i,u,l,c,h,f,s,g,v,m,d,y;for(typeof e!="function"&&(r=n,n=e,e=null),r=r||{},u=r.tolerance===void 0?1e-7:r.tolerance,y=r.epsilon===void 0?2220446049250313e-31:r.epsilon,l=r.maxIterations===void 0?20:r.maxIterations,v=r.h===void 0?1e-4:r.h,d=r.verbose===void 0?!1:r.verbose,m=1/v,c=0;c++<l;){if(o=t(n),e?i=e(n):(h=t(n+v),f=t(n-v),s=t(n+2*v),g=t(n-2*v),i=(g-s+8*(h-f))*m/12),Math.abs(i)<=y*Math.abs(o))return d&&console.log("Newton-Raphson: failed to converged due to nearly zero first derivative"),!1;if(a=n-o/i,Math.abs(a-n)<=u*Math.abs(a))return d&&console.log("Newton-Raphson: converged to x = "+a+" after "+c+" iterations"),a;n=a}return d&&console.log("Newton-Raphson: Maximum iterations reached ("+l+")"),!1}var B=z,p=1e3*60*60*24,D=365;function j(t){if(!t||!t.length||!t.forEach||t.length<2)throw new Error("Argument is not an array with length of 2 or more.");var e=[],n=Math.floor(t[0].when/p),r=n,a=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,i=0,u=0;if(t.forEach(function(l){i+=l.amount,l.amount<0&&(u+=-l.amount);var c=Math.floor(l.when/p);n=Math.min(n,c),r=Math.max(r,c),a=Math.min(a,l.amount),o=Math.max(o,l.amount),e.push({amount:l.amount,epochDays:c})}),n===r)throw new Error("Transactions must not all be on the same day.");if(a>=0)throw new Error("Transactions must not all be nonnegative.");if(o<0)throw new Error("Transactions must not all be negative.");return e.forEach(function(l){l.years=(r-l.epochDays)/D}),{total:i,deposits:u,days:r-n,investments:e,maxAmount:o}}function q(t,e){var n=j(t);if(n.maxAmount===0)return-1;var r=n.investments,a=function(l){return r.reduce(function(c,h){var f=h.amount,s=h.years;return-1<l?c+f*Math.pow(1+l,s):l<-1?c-Math.abs(f)*Math.pow(-1-l,s):s===0?c+f:c},0)},o=function(l){return r.reduce(function(c,h){var f=h.amount,s=h.years;return s===0?c:-1<l?c+f*s*Math.pow(1+l,s-1):l<-1?c+Math.abs(f)*s*Math.pow(-1-l,s-1):c},0)},i=e?e.guess:void 0;if(i&&isNaN(i))throw new Error("option.guess must be a number.");i||(i=n.total/n.deposits/(n.days/D));var u=B(a,o,i,e);if(u===!1)throw new Error("Newton-Raphson algorithm failed to converge.");return u}var G=q,k=X(G);function H(t,e){const n=J(t);return Q(n,e)}function J(t){const e=new Map;for(const r of t){if(r.type==="nil")continue;const a=w(r.when),o=e.get(a)||0;e.set(a,o+r.amount)}const n=Array.from(e.entries()).map(([r,a])=>({amount:a,when:new Date(r)}));return n.sort((r,a)=>r.when.getTime()-a.when.getTime()),n}function Q(t,e){try{return k(t)}catch(n){return console.warn(`XIRR calculation failed for date ${e.toISOString()}:`,n),null}}function W(t){const e=t.filter(a=>a.type==="nil"||a.type==="buy");if(e.length===0)return[];const n=Z(e),r=[];for(const[a,o]of n.entries()){const i=tt(o),u=et(o);i>0&&r.push({date:o[0].when,totalValue:i,cashFlow:u})}return r.sort((a,o)=>a.date.getTime()-o.date.getTime()),r}function Z(t){const e=new Map;for(const n of t){const r=nt(n.when);e.has(r)||e.set(r,[]),e.get(r).push(n)}return e}function tt(t){if(t.length===0)return 0;let e=0;for(const n of t)e+=n.currentValue;return e}function et(t){let e=0;for(const n of t)e+=n.amount;return e}function nt(t){const e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${e}-${n}-${r}`}const rt=252;function at(t){if(t.length<2)return 0;const e=ot(t);if(e.length<2)return 0;const n=e.reduce((h,f)=>h+f,0)/e.length,r=e.reduce((h,f)=>{const s=f-n;return h+s*s},0)/e.length,a=Math.sqrt(r),o=t.length-1,i=e.length,u=o>0?Math.round(i/o*365):rt;return a*Math.sqrt(u)*100||0}function ot(t){const e=[];for(let n=1;n<t.length;n++){const r=t[n-1],a=t[n];if(r.totalValue>0){const o=a.totalValue-r.totalValue;if(o===0&&a.cashFlow===0)continue;const i=(o+a.cashFlow)/r.totalValue;e.push(i)}}return e}function it(t){const e=W(t);return at(e)}function ut(t,e=1,n,r=!1,a=5,o=!1,i=!1,u=0,l=100){if(!V(t))return[];const c=e*12,h=t.map(b),f=h.map(E),s=R(h[0]),g=s[0];return s.flatMap(v=>lt(v,f,c,g,n,r,a,o,i,u,l))}function lt(t,e,n,r,a,o,i,u,l,c,h){const f=x(t,e,n,r,a,o,i,l,c,h);if(!f)return[];const s=H(f,t);if(s===null)return[];const g=it(f),v=u?f:f.filter(m=>m.type!=="nil");return[{date:t,xirr:Math.round(s*1e4)/1e4,transactions:v,volatility:Math.round(g*1e4)/1e4}]}export{ut as calculateSipRollingXirr};
//# sourceMappingURL=index-aa713000.js.map
