function V(t){if(t.length<2)return!0;const e=[...t].sort((n,r)=>n.date.getTime()-r.date.getTime());for(let n=1;n<e.length;n++){const r=e[n-1].date;if((e[n].date.getTime()-r.getTime())/864e5!==1)return!1}return!0}function E(t,e){const n=new Date(t),r=n.getDate();return n.setMonth(n.getMonth()-e),n.getDate()<r&&n.setDate(0),n}function N(t){if(t.length===0)return[];const e=[...t].sort((s,l)=>s.date.getTime()-l.date.getTime()),n=[];let r=0,a=new Date(e[0].date);const o=e[e.length-1].date;for(;a<=o;)r<e.length&&R(a,e[r].date)?(n.push({date:new Date(a),nav:e[r].nav}),r++):n.push({date:new Date(a),nav:e[r].nav}),a.setDate(a.getDate()+1);return n}function R(t,e){return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()}function D(t){return t.length>0&&!t.some(e=>e.length<2)}function T(t){return V(t)?t:N(t)}function M(t){return new Map(t.map(e=>[w(e.date),e]))}function b(t){return[...t].sort((e,n)=>e.date.getTime()-n.date.getTime()).map(e=>e.date)}function w(t){return t.toISOString().split("T")[0]}function A(t,e,n){const r=new Set;let a=null;for(let o=e;o>=1;o--){const s=E(t,o);if(s<n)return{dateSet:r,earliestDate:null};r.add(w(s)),(!a||s<a)&&(a=s)}return{dateSet:r,earliestDate:a}}function P(t,e){const n=t.getFullYear()-e.getFullYear(),r=t.getMonth()-e.getMonth();return n+(r>=0?0:-1)+1}function F(t,e,n,r,a,o,s,l,i){let u=i;if(s&&l>0){const g=P(a,o);u=i*Math.pow(1+l/100,g-1)}const h=[];let f=0;const c=[];for(let g=0;g<e.length;g++){const v=e[g].get(t);if(!v)return null;const m=u*(n[g]/100),d=m/v.nav;r.cumulativeUnits[g]+=d,r.unitsPerFund[g]+=d;const y=r.cumulativeUnits[g]*v.nav;c.push(y),f+=y,h.push({fundIdx:g,nav:v.nav,when:v.date,units:d,amount:-m,type:"buy",cumulativeUnits:r.cumulativeUnits[g],currentValue:y,allocationPercentage:0})}return h.forEach((g,v)=>{g.allocationPercentage=f>0?c[v]/f*100:0}),{transactions:h,portfolioValue:f}}function Y(t,e,n,r,a,o,s){if(!_(s.cumulativeUnits,n,t,r,a,o))return[];const l=[];for(let i=0;i<n.length;i++){const u=n[i].get(t);if(!u)return null;const h=s.cumulativeUnits[i]*u.nav,c=o*(r[i]/100)-h;if(Math.abs(c)>.01){const g=c/u.nav;s.cumulativeUnits[i]+=g,s.unitsPerFund[i]+=g,l.push({fundIdx:i,when:new Date(e),nav:u.nav,units:g,amount:-c,type:"rebalance",cumulativeUnits:s.cumulativeUnits[i],currentValue:s.cumulativeUnits[i]*u.nav,allocationPercentage:r[i]})}}return l}function _(t,e,n,r,a,o){for(let s=0;s<e.length;s++){const l=e[s].get(n);if(!l)continue;const u=t[s]*l.nav/o*100,h=r[s];if(Math.abs(u-h)>a)return!0}return!1}function U(t,e,n){const r=[];let a=0;for(let o=0;o<e.length;o++){const s=e[o].get(t);if(!s)return null;const l=n.cumulativeUnits[o]*s.nav;a+=l,r.push({fundIdx:o,when:s.date,nav:s.nav,units:0,amount:0,type:"nil",cumulativeUnits:n.cumulativeUnits[o],currentValue:l,allocationPercentage:0})}return r.forEach(o=>{o.allocationPercentage=a>0?o.currentValue/a*100:0}),r}function x(t,e,n){const r=w(t),a=[];for(let o=0;o<e.length;o++){const s=e[o].get(r);if(!s)return null;const l=n[o],i=l*s.nav;a.push({fundIdx:o,nav:s.nav,when:s.date,units:l,amount:i,type:"sell",cumulativeUnits:l,currentValue:l*s.nav})}return a}function I(t,e,n,r,a,o,s,l,i,u){const h=A(t,n,r);if(!h.earliestDate)return null;const f=C(e.length),c=O(h.earliestDate,t,h.dateSet,e,a,o,s,l,i,u,f);if(!c)return null;const g=x(t,e,f.unitsPerFund);return g?[...c,...g]:null}function C(t){return{unitsPerFund:new Array(t).fill(0),cumulativeUnits:new Array(t).fill(0)}}function O(t,e,n,r,a,o,s,l,i,u,h){const f=[],c=new Date(t),g=new Date(t);for(;c<e;){const v=w(c),d=n.has(v)?X(v,c,r,a,o,s,g,l,i,u,h):z(v,r,h);if(!d)return null;f.push(...d),c.setDate(c.getDate()+1)}return f}function X(t,e,n,r,a,o,s,l,i,u,h){const f=F(t,n,r,h,e,s,l,i,u);if(!f)return null;const c=a?Y(t,e,n,r,o,f.portfolioValue,h):[];return c===null?null:[...f.transactions,...c]}function z(t,e,n){return U(t,e,n)}function K(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var B=L;function L(t,e,n,r){var a,o,s,l,i,u,h,f,c,g,v,m,d,y;for(typeof e!="function"&&(r=n,n=e,e=null),r=r||{},l=r.tolerance===void 0?1e-7:r.tolerance,y=r.epsilon===void 0?2220446049250313e-31:r.epsilon,i=r.maxIterations===void 0?20:r.maxIterations,v=r.h===void 0?1e-4:r.h,d=r.verbose===void 0?!1:r.verbose,m=1/v,u=0;u++<i;){if(o=t(n),e?s=e(n):(h=t(n+v),f=t(n-v),c=t(n+2*v),g=t(n-2*v),s=(g-c+8*(h-f))*m/12),Math.abs(s)<=y*Math.abs(o))return d&&console.log("Newton-Raphson: failed to converged due to nearly zero first derivative"),!1;if(a=n-o/s,Math.abs(a-n)<=l*Math.abs(a))return d&&console.log("Newton-Raphson: converged to x = "+a+" after "+u+" iterations"),a;n=a}return d&&console.log("Newton-Raphson: Maximum iterations reached ("+i+")"),!1}var j=B,p=1e3*60*60*24,S=365;function q(t){if(!t||!t.length||!t.forEach||t.length<2)throw new Error("Argument is not an array with length of 2 or more.");var e=[],n=Math.floor(t[0].when/p),r=n,a=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,s=0,l=0;if(t.forEach(function(i){s+=i.amount,i.amount<0&&(l+=-i.amount);var u=Math.floor(i.when/p);n=Math.min(n,u),r=Math.max(r,u),a=Math.min(a,i.amount),o=Math.max(o,i.amount),e.push({amount:i.amount,epochDays:u})}),n===r)throw new Error("Transactions must not all be on the same day.");if(a>=0)throw new Error("Transactions must not all be nonnegative.");if(o<0)throw new Error("Transactions must not all be negative.");return e.forEach(function(i){i.years=(r-i.epochDays)/S}),{total:s,deposits:l,days:r-n,investments:e,maxAmount:o}}function G(t,e){var n=q(t);if(n.maxAmount===0)return-1;var r=n.investments,a=function(i){return r.reduce(function(u,h){var f=h.amount,c=h.years;return-1<i?u+f*Math.pow(1+i,c):i<-1?u-Math.abs(f)*Math.pow(-1-i,c):c===0?u+f:u},0)},o=function(i){return r.reduce(function(u,h){var f=h.amount,c=h.years;return c===0?u:-1<i?u+f*c*Math.pow(1+i,c-1):i<-1?u+Math.abs(f)*c*Math.pow(-1-i,c-1):u},0)},s=e?e.guess:void 0;if(s&&isNaN(s))throw new Error("option.guess must be a number.");s||(s=n.total/n.deposits/(n.days/S));var l=j(a,o,s,e);if(l===!1)throw new Error("Newton-Raphson algorithm failed to converge.");return l}var $=G,k=K($);function H(t,e){const n=J(t);return Q(n,e)}function J(t){const e=new Map;for(const r of t){if(r.type==="nil")continue;const a=w(r.when),o=e.get(a)||0;e.set(a,o+r.amount)}const n=Array.from(e.entries()).map(([r,a])=>({amount:a,when:new Date(r)}));return n.sort((r,a)=>r.when.getTime()-a.when.getTime()),n}function Q(t,e){try{return k(t)}catch(n){return console.warn(`XIRR calculation failed for date ${e.toISOString()}:`,n),null}}function W(t){const e=t.filter(a=>a.type==="nil"||a.type==="buy");if(e.length===0)return[];const n=Z(e),r=[];for(const[a,o]of n.entries()){const s=tt(o),l=et(o);s>0&&r.push({date:o[0].when,totalValue:s,cashFlow:l})}return r.sort((a,o)=>a.date.getTime()-o.date.getTime()),r}function Z(t){const e=new Map;for(const n of t){const r=n.when.toISOString().split("T")[0];e.has(r)||e.set(r,[]),e.get(r).push(n)}return e}function tt(t){return t.reduce((e,n)=>e+n.currentValue,0)}function et(t){return t.filter(e=>e.type==="buy").reduce((e,n)=>e+n.amount,0)}const nt=252;function rt(t){if(t.length<2)return 0;const e=at(t);if(e.length<2)return 0;const n=e.reduce((h,f)=>h+f,0)/e.length,r=e.reduce((h,f)=>{const c=f-n;return h+c*c},0)/e.length,a=Math.sqrt(r),o=t.length-1,s=e.length,l=o>0?Math.round(s/o*365):nt;return a*Math.sqrt(l)*100||0}function at(t){const e=[];for(let n=1;n<t.length;n++){const r=t[n-1],a=t[n];if(r.totalValue>0){const o=a.totalValue-r.totalValue;if(o===0&&a.cashFlow===0)continue;const s=(o+a.cashFlow)/r.totalValue;e.push(s)}}return e}function ot(t){const e=W(t);return rt(e)}function it(t,e=1,n,r=!1,a=5,o=!1,s=!1,l=0,i=100){if(!D(t))return[];const u=e*12,h=t.map(T),f=h.map(M),c=b(h[0]),g=c[0];return c.flatMap(v=>st(v,f,u,g,n,r,a,o,s,l,i))}function st(t,e,n,r,a,o,s,l,i,u,h){const f=I(t,e,n,r,a,o,s,i,u,h);if(!f)return[];const c=H(f,t);if(c===null)return[];const g=ot(f),v=l?f:f.filter(m=>m.type!=="nil");return[{date:t,xirr:Math.round(c*1e4)/1e4,transactions:v,volatility:Math.round(g*1e4)/1e4}]}function lt(t,e,n,r,a,o,s,l,i){if(!D(t))return null;const u=n*12,h=t.map(T),f=h.map(M),g=b(h[0])[0];return I(e,f,u,g,r,a,o,s,l,i)}export{it as calculateSipRollingXirr,lt as recalculateTransactionsForDate};
//# sourceMappingURL=index-83f1459a.js.map
