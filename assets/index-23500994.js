function T(e){if(e.length<2)return!0;const t=[...e].sort((n,r)=>n.date.getTime()-r.date.getTime());for(let n=1;n<t.length;n++){const r=t[n-1].date;if((t[n].date.getTime()-r.getTime())/864e5!==1)return!1}return!0}function M(e,t){const n=new Date(e),r=n.getDate();return n.setMonth(n.getMonth()-t),n.getDate()<r&&n.setDate(0),n}function I(e){if(e.length===0)return[];const t=[...e].sort((i,s)=>i.date.getTime()-s.date.getTime()),n=[];let r=0,a=new Date(t[0].date);const o=t[t.length-1].date;for(;a<=o;)r<t.length&&b(a,t[r].date)?(n.push({date:new Date(a),nav:t[r].nav}),r++):n.push({date:new Date(a),nav:t[r].nav}),a.setDate(a.getDate()+1);return n}function b(e,t){return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()}function S(e){return e.length>0&&!e.some(t=>t.length<2)}function V(e){return T(e)?e:I(e)}function E(e){return new Map(e.map(t=>[w(t.date),t]))}function R(e){return[...e].sort((t,n)=>t.date.getTime()-n.date.getTime()).map(t=>t.date)}function w(e){return e.toISOString().split("T")[0]}function A(e,t,n){const r=new Set;let a=null;for(let o=t;o>=1;o--){const i=M(e,o);if(i<n)return{dateSet:r,earliestDate:null};r.add(w(i)),(!a||i<a)&&(a=i)}return{dateSet:r,earliestDate:a}}function N(e,t){const n=e.getFullYear()-t.getFullYear(),r=e.getMonth()-t.getMonth();return n+(r>=0?0:-1)+1}function P(e,t,n,r,a,o,i,s,u){let c=u;if(i&&s>0){const g=N(a,o);c=u*Math.pow(1+s/100,g-1)}const h=[];let f=0;const l=[];for(let g=0;g<t.length;g++){const v=t[g].get(e);if(!v)return null;const m=c*(n[g]/100),d=m/v.nav;r.cumulativeUnits[g]+=d,r.unitsPerFund[g]+=d;const y=r.cumulativeUnits[g]*v.nav;l.push(y),f+=y,h.push({fundIdx:g,nav:v.nav,when:v.date,units:d,amount:-m,type:"buy",cumulativeUnits:r.cumulativeUnits[g],currentValue:y,allocationPercentage:0})}return h.forEach((g,v)=>{g.allocationPercentage=f>0?l[v]/f*100:0}),{transactions:h,portfolioValue:f}}function Y(e,t,n,r,a,o,i){if(!F(i.cumulativeUnits,n,e,r,a,o))return[];const s=[];for(let u=0;u<n.length;u++){const c=n[u].get(e);if(!c)return null;const h=i.cumulativeUnits[u]*c.nav,l=o*(r[u]/100)-h;if(Math.abs(l)>.01){const g=l/c.nav;i.cumulativeUnits[u]+=g,i.unitsPerFund[u]+=g,s.push({fundIdx:u,when:new Date(t),nav:c.nav,units:g,amount:-l,type:"rebalance",cumulativeUnits:i.cumulativeUnits[u],currentValue:i.cumulativeUnits[u]*c.nav,allocationPercentage:r[u]})}}return s}function F(e,t,n,r,a,o){for(let i=0;i<t.length;i++){const s=t[i].get(n);if(!s)continue;const c=e[i]*s.nav/o*100,h=r[i];if(Math.abs(c-h)>a)return!0}return!1}function _(e,t,n){const r=[];let a=0;for(let o=0;o<t.length;o++){const i=t[o].get(e);if(!i)return null;const s=n.cumulativeUnits[o]*i.nav;a+=s,r.push({fundIdx:o,when:i.date,nav:i.nav,units:0,amount:0,type:"nil",cumulativeUnits:n.cumulativeUnits[o],currentValue:s,allocationPercentage:0})}return r.forEach(o=>{o.allocationPercentage=a>0?o.currentValue/a*100:0}),r}function U(e,t,n){const r=w(e),a=[];for(let o=0;o<t.length;o++){const i=t[o].get(r);if(!i)return null;const s=n[o],u=s*i.nav;a.push({fundIdx:o,nav:i.nav,when:i.date,units:s,amount:u,type:"sell",cumulativeUnits:s,currentValue:s*i.nav})}return a}function x(e,t,n,r,a,o,i,s,u,c){const h=A(e,n,r);if(!h.earliestDate)return null;const f=C(t.length),l=O(h.earliestDate,e,h.dateSet,t,a,o,i,s,u,c,f);if(!l)return null;const g=U(e,t,f.unitsPerFund);return g?[...l,...g]:null}function C(e){return{unitsPerFund:new Array(e).fill(0),cumulativeUnits:new Array(e).fill(0)}}function O(e,t,n,r,a,o,i,s,u,c,h){const f=[],l=new Date(e),g=new Date(e);for(;l<t;){const v=w(l),d=n.has(v)?X(v,l,r,a,o,i,g,s,u,c,h):z(v,r,h);if(!d)return null;f.push(...d),l.setDate(l.getDate()+1)}return f}function X(e,t,n,r,a,o,i,s,u,c,h){const f=P(e,n,r,h,t,i,s,u,c);if(!f)return null;const l=a?Y(e,t,n,r,o,f.portfolioValue,h):[];return l===null?null:[...f.transactions,...l]}function z(e,t,n){return _(e,t,n)}function K(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var L=B;function B(e,t,n,r){var a,o,i,s,u,c,h,f,l,g,v,m,d,y;for(typeof t!="function"&&(r=n,n=t,t=null),r=r||{},s=r.tolerance===void 0?1e-7:r.tolerance,y=r.epsilon===void 0?2220446049250313e-31:r.epsilon,u=r.maxIterations===void 0?20:r.maxIterations,v=r.h===void 0?1e-4:r.h,d=r.verbose===void 0?!1:r.verbose,m=1/v,c=0;c++<u;){if(o=e(n),t?i=t(n):(h=e(n+v),f=e(n-v),l=e(n+2*v),g=e(n-2*v),i=(g-l+8*(h-f))*m/12),Math.abs(i)<=y*Math.abs(o))return d&&console.log("Newton-Raphson: failed to converged due to nearly zero first derivative"),!1;if(a=n-o/i,Math.abs(a-n)<=s*Math.abs(a))return d&&console.log("Newton-Raphson: converged to x = "+a+" after "+c+" iterations"),a;n=a}return d&&console.log("Newton-Raphson: Maximum iterations reached ("+u+")"),!1}var j=L,p=1e3*60*60*24,D=365;function q(e){if(!e||!e.length||!e.forEach||e.length<2)throw new Error("Argument is not an array with length of 2 or more.");var t=[],n=Math.floor(e[0].when/p),r=n,a=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,i=0,s=0;if(e.forEach(function(u){i+=u.amount,u.amount<0&&(s+=-u.amount);var c=Math.floor(u.when/p);n=Math.min(n,c),r=Math.max(r,c),a=Math.min(a,u.amount),o=Math.max(o,u.amount),t.push({amount:u.amount,epochDays:c})}),n===r)throw new Error("Transactions must not all be on the same day.");if(a>=0)throw new Error("Transactions must not all be nonnegative.");if(o<0)throw new Error("Transactions must not all be negative.");return t.forEach(function(u){u.years=(r-u.epochDays)/D}),{total:i,deposits:s,days:r-n,investments:t,maxAmount:o}}function G(e,t){var n=q(e);if(n.maxAmount===0)return-1;var r=n.investments,a=function(u){return r.reduce(function(c,h){var f=h.amount,l=h.years;return-1<u?c+f*Math.pow(1+u,l):u<-1?c-Math.abs(f)*Math.pow(-1-u,l):l===0?c+f:c},0)},o=function(u){return r.reduce(function(c,h){var f=h.amount,l=h.years;return l===0?c:-1<u?c+f*l*Math.pow(1+u,l-1):u<-1?c+Math.abs(f)*l*Math.pow(-1-u,l-1):c},0)},i=t?t.guess:void 0;if(i&&isNaN(i))throw new Error("option.guess must be a number.");i||(i=n.total/n.deposits/(n.days/D));var s=j(a,o,i,t);if(s===!1)throw new Error("Newton-Raphson algorithm failed to converge.");return s}var $=G,k=K($);function H(e,t){const n=J(e);return Q(n,t)}function J(e){const t=new Map;for(const r of e){if(r.type==="nil")continue;const a=w(r.when),o=t.get(a)||0;t.set(a,o+r.amount)}const n=Array.from(t.entries()).map(([r,a])=>({amount:a,when:new Date(r)}));return n.sort((r,a)=>r.when.getTime()-a.when.getTime()),n}function Q(e,t){try{return k(e)}catch(n){return console.warn(`XIRR calculation failed for date ${t.toISOString()}:`,n),null}}function W(e){const t=e.filter(a=>a.type==="nil"||a.type==="buy");if(t.length===0)return[];const n=Z(t),r=[];for(const[a,o]of n.entries()){const i=tt(o),s=et(o);i>0&&r.push({date:o[0].when,totalValue:i,cashFlow:s})}return r.sort((a,o)=>a.date.getTime()-o.date.getTime()),r}function Z(e){const t=new Map;for(const n of e){const r=n.when.toISOString().split("T")[0];t.has(r)||t.set(r,[]),t.get(r).push(n)}return t}function tt(e){return e.reduce((t,n)=>t+n.currentValue,0)}function et(e){return e.filter(t=>t.type==="buy").reduce((t,n)=>t+n.amount,0)}const nt=252;function rt(e){if(e.length<2)return 0;const t=at(e);if(t.length<2)return 0;const n=t.reduce((h,f)=>h+f,0)/t.length,r=t.reduce((h,f)=>{const l=f-n;return h+l*l},0)/t.length,a=Math.sqrt(r),o=e.length-1,i=t.length,s=o>0?Math.round(i/o*365):nt;return a*Math.sqrt(s)*100||0}function at(e){const t=[];for(let n=1;n<e.length;n++){const r=e[n-1],a=e[n];if(r.totalValue>0){const o=a.totalValue-r.totalValue;if(o===0&&a.cashFlow===0)continue;const i=(o+a.cashFlow)/r.totalValue;t.push(i)}}return t}function ot(e){const t=W(e);return rt(t)}function ut(e,t=1,n,r=!1,a=5,o=!1,i=!1,s=0,u=100){if(!S(e))return[];const c=t*12,h=e.map(V),f=h.map(E),l=R(h[0]),g=l[0];return l.flatMap(v=>it(v,f,c,g,n,r,a,o,i,s,u))}function it(e,t,n,r,a,o,i,s,u,c,h){const f=x(e,t,n,r,a,o,i,u,c,h);if(!f)return[];const l=H(f,e);if(l===null)return[];const g=ot(f),v=s?f:f.filter(m=>m.type!=="nil");return[{date:e,xirr:Math.round(l*1e4)/1e4,transactions:v,volatility:Math.round(g*1e4)/1e4}]}export{ut as calculateSipRollingXirr};
//# sourceMappingURL=index-23500994.js.map
