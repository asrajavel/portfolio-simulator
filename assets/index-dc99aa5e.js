function T(t){if(t.length<2)return!0;const e=[...t].sort((n,r)=>n.date.getTime()-r.date.getTime());for(let n=1;n<e.length;n++){const r=e[n-1].date;if((e[n].date.getTime()-r.getTime())/864e5!==1)return!1}return!0}function I(t,e){const n=new Date(t),r=n.getDate();return n.setMonth(n.getMonth()-e),n.getDate()<r&&n.setDate(0),n}function M(t){if(t.length===0)return[];const e=[...t].sort((o,s)=>o.date.getTime()-s.date.getTime()),n=[];let r=0,i=new Date(e[0].date);const u=e[e.length-1].date;for(;i<=u;)r<e.length&&S(i,e[r].date)?(n.push({date:new Date(i),nav:e[r].nav}),r++):n.push({date:new Date(i),nav:e[r].nav}),i.setDate(i.getDate()+1);return n}function S(t,e){return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()}function V(t){return t.length>0&&!t.some(e=>e.length<2)}function b(t){return T(t)?t:M(t)}function E(t){return new Map(t.map(e=>[d(e.date),e]))}function A(t){return[...t].sort((e,n)=>e.date.getTime()-n.date.getTime()).map(e=>e.date)}function d(t){return t.toISOString().split("T")[0]}function R(t,e,n){const r=new Set;let i=null;for(let u=e;u>=1;u--){const o=I(t,u);if(o<n)return{dateSet:r,earliestDate:null};r.add(d(o)),(!i||o<i)&&(i=o)}return{dateSet:r,earliestDate:i}}function N(t,e,n,r){const u=[];let o=0;const s=[];for(let a=0;a<e.length;a++){const l=e[a].get(t);if(!l)return null;const c=100*(n[a]/100),h=c/l.nav;r.cumulativeUnits[a]+=h,r.unitsPerFund[a]+=h;const f=r.cumulativeUnits[a]*l.nav;s.push(f),o+=f,u.push({fundIdx:a,nav:l.nav,when:l.date,units:h,amount:-c,type:"buy",cumulativeUnits:r.cumulativeUnits[a],currentValue:f,allocationPercentage:0})}return u.forEach((a,l)=>{a.allocationPercentage=o>0?s[l]/o*100:0}),{transactions:u,portfolioValue:o}}function P(t,e,n,r,i,u,o){if(!F(o.cumulativeUnits,n,t,r,i,u))return[];const s=[];for(let a=0;a<n.length;a++){const l=n[a].get(t);if(!l)return null;const c=o.cumulativeUnits[a]*l.nav,f=u*(r[a]/100)-c;if(Math.abs(f)>.01){const g=f/l.nav;o.cumulativeUnits[a]+=g,o.unitsPerFund[a]+=g,s.push({fundIdx:a,when:new Date(e),nav:l.nav,units:g,amount:-f,type:"rebalance",cumulativeUnits:o.cumulativeUnits[a],currentValue:o.cumulativeUnits[a]*l.nav,allocationPercentage:r[a]})}}return s}function F(t,e,n,r,i,u){for(let o=0;o<e.length;o++){const s=e[o].get(n);if(!s)continue;const l=t[o]*s.nav/u*100,c=r[o];if(Math.abs(l-c)>i)return!0}return!1}function U(t,e,n){const r=[];let i=0;for(let u=0;u<e.length;u++){const o=e[u].get(t);if(!o)return null;const s=n.cumulativeUnits[u]*o.nav;i+=s,r.push({fundIdx:u,when:o.date,nav:o.nav,units:0,amount:0,type:"nil",cumulativeUnits:n.cumulativeUnits[u],currentValue:s,allocationPercentage:0})}return r.forEach(u=>{u.allocationPercentage=i>0?u.currentValue/i*100:0}),r}function _(t,e,n){const r=d(t),i=[];for(let u=0;u<e.length;u++){const o=e[u].get(r);if(!o)return null;const s=n[u],a=s*o.nav;i.push({fundIdx:u,nav:o.nav,when:o.date,units:s,amount:a,type:"sell",cumulativeUnits:s,currentValue:s*o.nav})}return i}function Y(t,e,n,r,i,u,o){const s=R(t,n,r);if(!s.earliestDate)return null;const a=x(e.length),l=C(s.earliestDate,t,s.dateSet,e,i,u,o,a);if(!l)return null;const c=_(t,e,a.unitsPerFund);return c?[...l,...c]:null}function x(t){return{unitsPerFund:new Array(t).fill(0),cumulativeUnits:new Array(t).fill(0)}}function C(t,e,n,r,i,u,o,s){const a=[],l=new Date(t);for(;l<e;){const c=d(l),f=n.has(c)?O(c,l,r,i,u,o,s):$(c,r,s);if(!f)return null;a.push(...f),l.setDate(l.getDate()+1)}return a}function O(t,e,n,r,i,u,o){const s=N(t,n,r,o);if(!s)return null;const a=i?P(t,e,n,r,u,s.portfolioValue,o):[];return a===null?null:[...s.transactions,...a]}function $(t,e,n){return U(t,e,n)}function K(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var X=z;function z(t,e,n,r){var i,u,o,s,a,l,c,h,f,g,v,y,m,w;for(typeof e!="function"&&(r=n,n=e,e=null),r=r||{},s=r.tolerance===void 0?1e-7:r.tolerance,w=r.epsilon===void 0?2220446049250313e-31:r.epsilon,a=r.maxIterations===void 0?20:r.maxIterations,v=r.h===void 0?1e-4:r.h,m=r.verbose===void 0?!1:r.verbose,y=1/v,l=0;l++<a;){if(u=t(n),e?o=e(n):(c=t(n+v),h=t(n-v),f=t(n+2*v),g=t(n-2*v),o=(g-f+8*(c-h))*y/12),Math.abs(o)<=w*Math.abs(u))return m&&console.log("Newton-Raphson: failed to converged due to nearly zero first derivative"),!1;if(i=n-u/o,Math.abs(i-n)<=s*Math.abs(i))return m&&console.log("Newton-Raphson: converged to x = "+i+" after "+l+" iterations"),i;n=i}return m&&console.log("Newton-Raphson: Maximum iterations reached ("+a+")"),!1}var L=X,p=1e3*60*60*24,D=365;function B(t){if(!t||!t.length||!t.forEach||t.length<2)throw new Error("Argument is not an array with length of 2 or more.");var e=[],n=Math.floor(t[0].when/p),r=n,i=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,o=0,s=0;if(t.forEach(function(a){o+=a.amount,a.amount<0&&(s+=-a.amount);var l=Math.floor(a.when/p);n=Math.min(n,l),r=Math.max(r,l),i=Math.min(i,a.amount),u=Math.max(u,a.amount),e.push({amount:a.amount,epochDays:l})}),n===r)throw new Error("Transactions must not all be on the same day.");if(i>=0)throw new Error("Transactions must not all be nonnegative.");if(u<0)throw new Error("Transactions must not all be negative.");return e.forEach(function(a){a.years=(r-a.epochDays)/D}),{total:o,deposits:s,days:r-n,investments:e,maxAmount:u}}function j(t,e){var n=B(t);if(n.maxAmount===0)return-1;var r=n.investments,i=function(a){return r.reduce(function(l,c){var h=c.amount,f=c.years;return-1<a?l+h*Math.pow(1+a,f):a<-1?l-Math.abs(h)*Math.pow(-1-a,f):f===0?l+h:l},0)},u=function(a){return r.reduce(function(l,c){var h=c.amount,f=c.years;return f===0?l:-1<a?l+h*f*Math.pow(1+a,f-1):a<-1?l+Math.abs(h)*f*Math.pow(-1-a,f-1):l},0)},o=e?e.guess:void 0;if(o&&isNaN(o))throw new Error("option.guess must be a number.");o||(o=n.total/n.deposits/(n.days/D));var s=L(i,u,o,e);if(s===!1)throw new Error("Newton-Raphson algorithm failed to converge.");return s}var q=j,G=K(q);function k(t,e){const n=H(t);return J(n,e)}function H(t){const e=new Map;for(const r of t){if(r.type==="nil")continue;const i=d(r.when),u=e.get(i)||0;e.set(i,u+r.amount)}const n=Array.from(e.entries()).map(([r,i])=>({amount:i,when:new Date(r)}));return n.sort((r,i)=>r.when.getTime()-i.when.getTime()),n}function J(t,e){try{return G(t)}catch(n){return console.warn(`XIRR calculation failed for date ${e.toISOString()}:`,n),null}}function Q(t){const e=t.filter(i=>i.type==="nil"||i.type==="buy");if(e.length===0)return[];const n=W(e),r=[];for(const[i,u]of n.entries()){const o=Z(u),s=tt(u);o>0&&r.push({date:u[0].when,totalValue:o,cashFlow:s})}return r.sort((i,u)=>i.date.getTime()-u.date.getTime()),r}function W(t){const e=new Map;for(const n of t){const r=et(n.when);e.has(r)||e.set(r,[]),e.get(r).push(n)}return e}function Z(t){if(t.length===0)return 0;let e=0;for(const n of t)e+=n.currentValue;return e}function tt(t){let e=0;for(const n of t)e+=n.amount;return e}function et(t){const e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${e}-${n}-${r}`}const nt=252;function rt(t){if(t.length<2)return 0;const e=at(t);if(e.length<2)return 0;const n=e.reduce((c,h)=>c+h,0)/e.length,r=e.reduce((c,h)=>{const f=h-n;return c+f*f},0)/e.length,i=Math.sqrt(r),u=t.length-1,o=e.length,s=u>0?Math.round(o/u*365):nt;return i*Math.sqrt(s)*100||0}function at(t){const e=[];for(let n=1;n<t.length;n++){const r=t[n-1],i=t[n];if(r.totalValue>0){const u=i.totalValue-r.totalValue;if(u===0&&i.cashFlow===0)continue;const o=(u+i.cashFlow)/r.totalValue;e.push(o)}}return e}function ot(t){const e=Q(t);return rt(e)}function ut(t,e=1,n,r=!1,i=5,u=!1){if(!V(t))return[];const o=e*12,s=t.map(b),a=s.map(E),l=A(s[0]),c=l[0];return l.flatMap(h=>it(h,a,o,c,n,r,i,u))}function it(t,e,n,r,i,u,o,s){const a=Y(t,e,n,r,i,u,o);if(!a)return[];const l=k(a,t);if(l===null)return[];const c=ot(a),h=s?a:a.filter(f=>f.type!=="nil");return[{date:t,xirr:l,transactions:h,volatility:c}]}export{ut as calculateSipRollingXirr};
//# sourceMappingURL=index-dc99aa5e.js.map
