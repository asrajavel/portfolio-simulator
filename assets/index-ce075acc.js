function I(t){if(t.length<2)return!0;const e=[...t].sort((n,r)=>n.date.getTime()-r.date.getTime());for(let n=1;n<e.length;n++){const r=e[n-1].date;if((e[n].date.getTime()-r.getTime())/864e5!==1)return!1}return!0}function T(t,e){const n=new Date(t),r=n.getDate();return n.setMonth(n.getMonth()-e),n.getDate()<r&&n.setDate(0),n}function b(t){if(t.length===0)return[];const e=[...t].sort((o,l)=>o.date.getTime()-l.date.getTime()),n=[];let r=0,i=new Date(e[0].date);const u=e[e.length-1].date;for(;i<=u;)r<e.length&&M(i,e[r].date)?(n.push({date:new Date(i),nav:e[r].nav}),r++):n.push({date:new Date(i),nav:e[r].nav}),i.setDate(i.getDate()+1);return n}function M(t,e){return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()}function S(t){return t.length>0&&!t.some(e=>e.length<2)}function N(t){return I(t)?t:b(t)}function A(t){return new Map(t.map(e=>[m(e.date),e]))}function E(t){return[...t].sort((e,n)=>e.date.getTime()-n.date.getTime()).map(e=>e.date)}function m(t){return t.toISOString().split("T")[0]}function V(t,e,n){const r=new Set;let i=null;for(let u=e;u>=1;u--){const o=T(t,u);if(o<n)return{dateSet:r,earliestDate:null};r.add(m(o)),(!i||o<i)&&(i=o)}return{dateSet:r,earliestDate:i}}function P(t,e,n,r){const u=[];let o=0;const l=[];for(let a=0;a<e.length;a++){const s=e[a].get(t);if(!s)return null;const c=100*(n[a]/100),h=c/s.nav;r.cumulativeUnits[a]+=h,r.unitsPerFund[a]+=h;const f=r.cumulativeUnits[a]*s.nav;l.push(f),o+=f,u.push({fundIdx:a,nav:s.nav,when:s.date,units:h,amount:-c,type:"buy",cumulativeUnits:r.cumulativeUnits[a],currentValue:f,allocationPercentage:0})}return u.forEach((a,s)=>{a.allocationPercentage=o>0?l[s]/o*100:0}),{transactions:u,portfolioValue:o}}function R(t,e,n,r,i,u,o){if(!U(o.cumulativeUnits,n,t,r,i,u))return[];const l=[];for(let a=0;a<n.length;a++){const s=n[a].get(t);if(!s)return null;const c=o.cumulativeUnits[a]*s.nav,f=u*(r[a]/100)-c;if(Math.abs(f)>.01){const v=f/s.nav;o.cumulativeUnits[a]+=v,o.unitsPerFund[a]+=v,l.push({fundIdx:a,when:new Date(e),nav:s.nav,units:v,amount:-f,type:"rebalance",cumulativeUnits:o.cumulativeUnits[a],currentValue:o.cumulativeUnits[a]*s.nav,allocationPercentage:r[a]})}}return l}function U(t,e,n,r,i,u){for(let o=0;o<e.length;o++){const l=e[o].get(n);if(!l)continue;const s=t[o]*l.nav/u*100,c=r[o];if(Math.abs(s-c)>i)return!0}return!1}function _(t,e,n){const r=[];let i=0;for(let u=0;u<e.length;u++){const o=e[u].get(t);if(!o)return null;const l=n.cumulativeUnits[u]*o.nav;i+=l,r.push({fundIdx:u,when:o.date,nav:o.nav,units:0,amount:0,type:"nil",cumulativeUnits:n.cumulativeUnits[u],currentValue:l,allocationPercentage:0})}return r.forEach(u=>{u.allocationPercentage=i>0?u.currentValue/i*100:0}),r}function F(t,e,n){const r=m(t),i=[];for(let u=0;u<e.length;u++){const o=e[u].get(r);if(!o)return null;const l=n[u],a=l*o.nav;i.push({fundIdx:u,nav:o.nav,when:o.date,units:l,amount:a,type:"sell",cumulativeUnits:l,currentValue:l*o.nav})}return i}function Y(t,e,n,r,i,u,o){const l=V(t,n,r);if(!l.earliestDate)return null;const a=x(e.length),s=O(l.earliestDate,t,l.dateSet,e,i,u,o,a);if(!s)return null;const c=F(t,e,a.unitsPerFund);return c?[...s,...c]:null}function x(t){return{unitsPerFund:new Array(t).fill(0),cumulativeUnits:new Array(t).fill(0)}}function O(t,e,n,r,i,u,o,l){const a=[],s=new Date(t);for(;s<e;){const c=m(s),f=n.has(c)?C(c,s,r,i,u,o,l):X(c,r,l);if(!f)return null;a.push(...f),s.setDate(s.getDate()+1)}return a}function C(t,e,n,r,i,u,o){const l=P(t,n,r,o);if(!l)return null;const a=i?R(t,e,n,r,u,l.portfolioValue,o):[];return a===null?null:[...l.transactions,...a]}function X(t,e,n){return _(t,e,n)}function L(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var j=z;function z(t,e,n,r){var i,u,o,l,a,s,c,h,f,v,g,w,d,p;for(typeof e!="function"&&(r=n,n=e,e=null),r=r||{},l=r.tolerance===void 0?1e-7:r.tolerance,p=r.epsilon===void 0?2220446049250313e-31:r.epsilon,a=r.maxIterations===void 0?20:r.maxIterations,g=r.h===void 0?1e-4:r.h,d=r.verbose===void 0?!1:r.verbose,w=1/g,s=0;s++<a;){if(u=t(n),e?o=e(n):(c=t(n+g),h=t(n-g),f=t(n+2*g),v=t(n-2*g),o=(v-f+8*(c-h))*w/12),Math.abs(o)<=p*Math.abs(u))return d&&console.log("Newton-Raphson: failed to converged due to nearly zero first derivative"),!1;if(i=n-u/o,Math.abs(i-n)<=l*Math.abs(i))return d&&console.log("Newton-Raphson: converged to x = "+i+" after "+s+" iterations"),i;n=i}return d&&console.log("Newton-Raphson: Maximum iterations reached ("+a+")"),!1}var K=j,y=1e3*60*60*24,D=365;function $(t){if(!t||!t.length||!t.forEach||t.length<2)throw new Error("Argument is not an array with length of 2 or more.");var e=[],n=Math.floor(t[0].when/y),r=n,i=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,o=0,l=0;if(t.forEach(function(a){o+=a.amount,a.amount<0&&(l+=-a.amount);var s=Math.floor(a.when/y);n=Math.min(n,s),r=Math.max(r,s),i=Math.min(i,a.amount),u=Math.max(u,a.amount),e.push({amount:a.amount,epochDays:s})}),n===r)throw new Error("Transactions must not all be on the same day.");if(i>=0)throw new Error("Transactions must not all be nonnegative.");if(u<0)throw new Error("Transactions must not all be negative.");return e.forEach(function(a){a.years=(r-a.epochDays)/D}),{total:o,deposits:l,days:r-n,investments:e,maxAmount:u}}function B(t,e){var n=$(t);if(n.maxAmount===0)return-1;var r=n.investments,i=function(a){return r.reduce(function(s,c){var h=c.amount,f=c.years;return-1<a?s+h*Math.pow(1+a,f):a<-1?s-Math.abs(h)*Math.pow(-1-a,f):f===0?s+h:s},0)},u=function(a){return r.reduce(function(s,c){var h=c.amount,f=c.years;return f===0?s:-1<a?s+h*f*Math.pow(1+a,f-1):a<-1?s+Math.abs(h)*f*Math.pow(-1-a,f-1):s},0)},o=e?e.guess:void 0;if(o&&isNaN(o))throw new Error("option.guess must be a number.");o||(o=n.total/n.deposits/(n.days/D));var l=K(i,u,o,e);if(l===!1)throw new Error("Newton-Raphson algorithm failed to converge.");return l}var G=B,k=L(G);function q(t,e){const n=H(t);return J(n,e)}function H(t){const e=new Map;for(const r of t){if(r.type==="nil")continue;const i=m(r.when),u=e.get(i)||0;e.set(i,u+r.amount)}const n=Array.from(e.entries()).map(([r,i])=>({amount:i,when:new Date(r)}));return n.sort((r,i)=>r.when.getTime()-i.when.getTime()),n}function J(t,e){try{return k(t)}catch(n){return console.warn(`XIRR calculation failed for date ${e.toISOString()}:`,n),null}}function W(t,e=1,n,r=!1,i=5,u=!1){if(!S(t))return[];const o=e*12,l=t.map(N),a=l.map(A),s=E(l[0]),c=s[0];return s.flatMap(h=>Q(h,a,o,c,n,r,i,u))}function Q(t,e,n,r,i,u,o,l){const a=Y(t,e,n,r,i,u,o);if(!a)return[];const s=q(a,t);if(s===null)return[];const c=l?a:a.filter(h=>h.type!=="nil");return[{date:t,xirr:s,transactions:c}]}export{W as calculateSipRollingXirr};
